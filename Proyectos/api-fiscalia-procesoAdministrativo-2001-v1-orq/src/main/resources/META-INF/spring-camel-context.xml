<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:camel="http://camel.apache.org/schema/spring"
	xsi:schemaLocation="
         http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
         http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd">
         
         
    <bean id="construyeArrayMaps" class="cl.supereduc.iesb.ConstruyeArrayMaps"/>

	<camelContext xmlns="http://camel.apache.org/schema/spring" id="api-fiscalia-procesoAdministrativo-2001-v1-orq">
	
		<onException>
			    <exception>java.lang.Exception</exception>
			    <handled><simple>true</simple></handled>
			    <setHeader headerName="codeError"><constant>500</constant></setHeader>
			    <setHeader headerName="messageError"><simple>Internal Error - ${exception.message}</simple></setHeader>
			    <to uri="velocity:velocity/sqlException-json.vm"/>
		</onException> 
		

		<route id="orquestador">
			<from uri="direct-vm:api-fiscalia-procesoAdministrativo-2001-v1-orq" />
			
			
			<log message="headers.numeroActa: ${headers.numeroActa}"></log>
			
			<to uri="direct-vm:api-fiscalia-procesoAdministrativo-2001-v1-vm" />
			
			<log message="cuerpo: ${body}"></log>
			
			<split>
				<simple>${body}</simple>
				
				<setHeader headerName="numeroActaConsulta"><simple>${body[NumeroActa]}</simple></setHeader>
				<setHeader headerName="fechaIngreso"><simple>${body[FechaIngreso]}</simple></setHeader>
				<setHeader headerName="tipoPrograma"><simple>${body[TipoPrograma]}</simple></setHeader>
				<setHeader headerName="estadoActa"><simple>${body[EstadoActa]}</simple></setHeader>
				
				<to uri="direct-vm:1203-fiscalia-acta-numero" />
				<log message="1203-fiscalia-acta-numero ${body}"></log>
				<setHeader headerName="status"><jsonpath>$.success</jsonpath></setHeader>
				<choice>
					<when>
						<simple>${headers.status} == true</simple>
						<setHeader headerName="fiscal"><jsonpath>$.payload.row.fiscal</jsonpath></setHeader>
						<log message="fiscal 1"></log>
					</when>
				</choice>
				
				<log message="fiscal 2"></log>
				<to uri="direct-vm:1204-fiscalia-sancion-primera" />
				<log message="fiscal 3"></log>
				<log message="1204-fiscalia-sancion-primera: ${body}"></log>
				<setHeader headerName="status"><jsonpath>$.success</jsonpath></setHeader>
				<choice>
					<when>
						<simple>${headers.status} == true</simple>
						
						<setHeader headerName="sancionPrimeraInstancia"><jsonpath>$.payload.row.SancionPrimeraInstancia</jsonpath></setHeader>
						<setHeader headerName="montoMulta20529Primera"><jsonpath>$.payload.row.MontoMulta20529</jsonpath></setHeader>
						<setHeader headerName="montoReintegroPrimera"><jsonpath>$.payload.row.MontoReintegro</jsonpath></setHeader>
					</when>
				</choice>
				
				<to uri="direct-vm:1205-fiscalia-sancion-segunda" />
				<log message="1205-fiscalia-sancion-segunda: ${body}"></log>
				<setHeader headerName="status"><jsonpath>$.success</jsonpath></setHeader>
				<choice>
					<when>
						<simple>${headers.status} == true</simple>
						
						<setHeader headerName="sancionSegundaInstancia"><jsonpath>$.payload.row.SancionSegundaInstancia</jsonpath></setHeader>
						<setHeader headerName="montoMulta20529Segunda"><jsonpath>$.payload.row.MontoMulta20529</jsonpath></setHeader>
						<setHeader headerName="montoReintegroSegunda"><jsonpath>$.payload.row.MontoReintegro</jsonpath></setHeader>
					</when>
				</choice>
								
				<to uri="direct-vm:1206-fiscalia-sancion-corte" />
				<log message="1206-fiscalia-sancion-corte: ${body}"></log>
				<setHeader headerName="status"><jsonpath>$.success</jsonpath></setHeader>
				<choice>
					<when>
						<simple>${headers.status} == true</simple>
						
						<setHeader headerName="sancionEnLaCorte"><jsonpath>$.payload.row.SancionEnLaCorte</jsonpath></setHeader>
						<setHeader headerName="montoMulta20529Corte"><jsonpath>$.payload.row.MontoMulta20529</jsonpath></setHeader>
						<setHeader headerName="montoReintegroCorte"><jsonpath>$.payload.row.MontoReintegro</jsonpath></setHeader>
					</when>
				</choice>
				
				<to uri="direct-vm:1207-basico-fiscalia-sancion-estado" />
				<log message="1207-basico-fiscalia-sancion-estado: ${body}"></log>
				<setHeader headerName="status"><jsonpath>$.success</jsonpath></setHeader>
				<choice>
					<when>
						<simple>${headers.status} == true</simple>
						
						<setHeader headerName="estadoActa"><jsonpath>$.payload.row.EstadoActa</jsonpath></setHeader>
					</when>
				</choice>
				
				<bean ref="construyeArrayMaps" method="incorporaValorLista" />
			</split>
			
			<bean ref="construyeArrayMaps" method="generaSalidaOrquestador" />
			
			<log message="cuerpo 2: ${body}"></log>
			
			<to uri="velocity:velocity/listaRespuesta-json.vm"/>
		</route>
	</camelContext>
</beans>