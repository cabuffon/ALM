sql.respuesta = SELECT (SELECT CASE WHEN dbo.IDEstadoExpediente(dbo.[003_Acta].ID) < 4 THEN '---' ELSE (SELECT NombreCompleto FROM [dbo].[001_Usuario] WHERE ID = (SELECT TOP 1 ID_Usuario FROM [dbo].[004_Seguimiento] WHERE ID_Acta = [dbo].[003_Acta].ID AND ID_Estado = dbo.IDEstadoExpediente(dbo.[003_Acta].ID) AND Eli = 0)) END) AS Fiscal FROM dbo.[003_Acta] INNER JOIN dbo.[001_Usuario] ON dbo.[003_Acta].ID_Usuario = dbo.[001_Usuario].ID INNER JOIN dbo.[Actas] ON dbo.[003_Acta].Numero = dbo.[Actas].NumeroActa WHERE (dbo.[Actas].FechaIngreso BETWEEN '2014-01-01' AND '2016-12-31') AND (dbo.[Actas].FechaInicioVisita BETWEEN '2014-01-01' AND '2016-12-31') AND (dbo.[Actas].Eliminado = 0) AND (dbo.[003_Acta].Eli = 0) AND (dbo.[003_Acta].ID_Usuario = dbo.[Actas].ID_Usuario)  AND '---' <> ( SELECT (CASE WHEN cantidadC > 0 AND cantidadB > 0 THEN 'CON OBSERVACIONES' WHEN cantidadC > 0 AND cantidadB = 0 THEN 'CON OBSERVACIONES' WHEN cantidadC = 0 AND cantidadB > 0 THEN 'B' ELSE '---' END) AS tipoCodigo FROM ( SELECT ((LEN(CONVERT(VARCHAR, Codigos)) - DATALENGTH(REPLACE(CONVERT(VARCHAR, Codigos), 'C', ''))) / LEN('C')) AS cantidadC, ((LEN(CONVERT(VARCHAR, Codigos)) - DATALENGTH(REPLACE(CONVERT(VARCHAR, Codigos), 'B', ''))) / LEN('B')) AS cantidadB FROM ( SELECT STUFF( (SELECT ', ' + CAST(DC.TipoCodigo AS VARCHAR(1)) FROM [dbo].[CodigosActas] DCA, [dbo].[Codigos] DC WHERE DCA.id_Codigo = DC.id_Codigo AND DCA.idActa = dbo.[Actas].idActa FOR XML PATH ('')) , 1, 1, '') AS Codigos ) T) Q ) AND dbo.[Actas].NumeroActa = :#numeroActa