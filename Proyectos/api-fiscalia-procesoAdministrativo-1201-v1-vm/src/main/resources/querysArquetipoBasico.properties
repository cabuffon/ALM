sql.respuesta = SELECT (CASE LEN(dbo.[003_Acta].Numero) WHEN 10 THEN SUBSTRING(CAST(dbo.[003_Acta].Numero AS VARCHAR(10)), 5, 2) WHEN 9 THEN SUBSTRING(CAST(dbo.[003_Acta].Numero AS VARCHAR(10)), 1, 2) ELSE '---' END) AS AnioActa, (CASE LEN(dbo.[003_Acta].Numero) WHEN 10 THEN SUBSTRING(CAST(dbo.[003_Acta].Numero AS VARCHAR(10)), 2, 2) WHEN 9 THEN SUBSTRING(CAST(dbo.[003_Acta].Numero AS VARCHAR(10)), 3, 2) ELSE '---' END) AS RegionActa, dbo.[003_Acta].Numero, dbo.[Actas].FechaIngreso AS FechaIngreso, (SELECT TipoPrograma FROM [dbo].[TipoPrograma] WHERE idTipoPrograma = dbo.[Actas].idTipoPrograma) AS TipoPrograma,  ( SELECT (CASE WHEN cantidadC > 0 AND cantidadB > 0 THEN 'CON OBSERVACIONES' WHEN cantidadC > 0 AND cantidadB = 0 THEN 'CON OBSERVACIONES' WHEN cantidadC = 0 AND cantidadB > 0 THEN 'B' ELSE '---' END) AS tipoCodigo FROM ( SELECT Codigos, ((LEN(CONVERT(VARCHAR, Codigos)) - DATALENGTH(REPLACE(CONVERT(VARCHAR, Codigos), 'C', ''))) / LEN('C')) AS cantidadC, ((LEN(CONVERT(VARCHAR, Codigos)) - DATALENGTH(REPLACE(CONVERT(VARCHAR, Codigos), 'B', ''))) / LEN('B')) AS cantidadB FROM ( SELECT STUFF( (SELECT ', ' + CAST(DC.TipoCodigo AS VARCHAR(1)) FROM [dbo].[CodigosActas] DCA, [dbo].[Codigos] DC WHERE DCA.id_Codigo = DC.id_Codigo AND DCA.idActa = dbo.[Actas].idActa FOR XML PATH ('')) , 1, 1, '') AS Codigos ) T) Q ) AS TipoActa,  dbo.[003_Acta].RBD, (SELECT STUFF( (SELECT ', ' + CAST(DC.[Codigo] AS VARCHAR(10)) FROM [dbo].[CodigosActas] DCA, [dbo].[Codigos] DC WHERE DCA.id_Codigo = DC.id_Codigo AND DCA.idActa = dbo.[Actas].idActa FOR XML PATH ('')) , 1, 1, '')) AS SustN, dbo.obt_CodigosActasNombres([dbo].[Actas].idActa) AS nombreSustN,  dbo.EstadoExpediente(dbo.[003_Acta].ID) AS EstadoActa,  (CASE dbo.IDEstadoExpediente(dbo.[003_Acta].ID) WHEN 8 THEN 'Terminado' WHEN 3 THEN 'Terminado' ELSE 'Pendiente' END) AS EstadoPendienteTerminado   FROM dbo.[003_Acta] INNER JOIN dbo.[001_Usuario] ON dbo.[003_Acta].ID_Usuario = dbo.[001_Usuario].ID INNER JOIN dbo.[006_DatosActaSIFS] ON dbo.[003_Acta].ID = dbo.[006_DatosActaSIFS].ID_Acta INNER JOIN dbo.[010_TipoProcesos] ON dbo.[003_Acta].Tipo = dbo.[010_TipoProcesos].ID INNER JOIN dbo.[Actas] ON dbo.[003_Acta].Numero = dbo.[Actas].NumeroActa AND (dbo.[Actas].Eliminado = 0) AND (dbo.[003_Acta].Eli = 0) AND (dbo.[003_Acta].ID_Usuario = dbo.[Actas].ID_Usuario) AND '---' <> ( SELECT (CASE WHEN cantidadC > 0 AND cantidadB > 0 THEN 'CON OBSERVACIONES' WHEN cantidadC > 0 AND cantidadB = 0 THEN 'CON OBSERVACIONES' WHEN cantidadC = 0 AND cantidadB > 0 THEN 'B' ELSE '---' END) AS tipoCodigo FROM ( SELECT ((LEN(CONVERT(VARCHAR, Codigos)) - DATALENGTH(REPLACE(CONVERT(VARCHAR, Codigos), 'C', ''))) / LEN('C')) AS cantidadC, ((LEN(CONVERT(VARCHAR, Codigos)) - DATALENGTH(REPLACE(CONVERT(VARCHAR, Codigos), 'B', ''))) / LEN('B')) AS cantidadB FROM ( SELECT STUFF( (SELECT ', ' + CAST(DC.TipoCodigo AS VARCHAR(1)) FROM [dbo].[CodigosActas] DCA, [dbo].[Codigos] DC WHERE DCA.id_Codigo = DC.id_Codigo AND DCA.idActa = dbo.[Actas].idActa FOR XML PATH ('')) , 1, 1, '') AS Codigos ) T) Q ) WHERE YEAR(dbo.[003_Acta].Fecha) = :#param